{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Lista de Campanhas</h2>
    <a href="{{ url_for('create_campaign') }}" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Criar Nova Campanha</a>
</div>

{% if campaigns %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="thead-light">
                <tr>
                    <th>ID</th>
                    <th>Nome (CSV)</th>
                    <th style="min-width: 180px;">Mensagem (Início)</th>
                    <th>Imagem</th>
                    <th>Status</th>
                    <th>Progresso</th>
                    <th>Criada em</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for campaign in campaigns %}
                <tr data-campaign-id="{{ campaign.campaign_id }}"> {# Atributo para identificar a linha via JS #}
                    <td><small>{{ campaign.campaign_id }}</small></td>
                    <td>{{ campaign.csv_filename }}</td>
                    <td><small>{{ campaign.message_template[:50] }}{% if campaign.message_template|length > 50 %}...{% endif %}</small></td>
                    <td><small>{{ campaign.image_filename if campaign.image_filename else 'Nenhuma' }}</small></td>
                    <td class="campaign-status-cell"> {# Classe para fácil acesso via JS #}
                        <span class="badge badge-pill
                            {% if campaign.status == 'COMPLETED' %}badge-success
                            {% elif campaign.status == 'IN_PROGRESS' %}badge-info
                            {% elif campaign.status == 'PENDING' %}badge-secondary
                            {% elif campaign.status in ['FAILED', 'FAILED_NO_CONTACTS'] %}badge-danger
                            {% elif campaign.status == 'COMPLETED_WITH_ERRORS' %}badge-warning
                            {% elif campaign.status == 'PAUSED' %}badge-warning
                            {% else %}badge-light
                            {% endif %}">
                            {{ campaign.status.replace('_', ' ')|title }}
                        </span>
                    </td>
                    <td class="campaign-progress-cell" style="min-width: 180px;"> {# Nova célula para progresso #}
                        <div id="progress-text-{{ campaign.campaign_id }}">
                            {% if campaign.status == 'IN_PROGRESS' %}
                                Carregando...
                            {% elif campaign.status not in ['PENDING', 'PAUSED'] %}
                                N/A
                            {% else %}
                                Aguardando início
                            {% endif %}
                        </div>
                        <div class="progress" id="progress-bar-container-{{ campaign.campaign_id }}" style="height: 10px; margin-top: 5px; display: none;">
                            <div id="progress-bar-{{ campaign.campaign_id }}" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </td>
                    <td><small>{{ campaign.created_at.split('.')[0] if campaign.created_at else 'N/A' }}</small></td>
                    <td class="campaign-action-cell"> {# Classe para fácil acesso via JS #}
                        {% if campaign.status in ['PENDING', 'PAUSED', 'FAILED', 'COMPLETED_WITH_ERRORS'] %}
                            <form action="{{ url_for('start_campaign_processing_route', campaign_id=campaign.campaign_id) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-success btn-start-campaign" title="Iniciar/Retomar Disparos">
                                    <i class="fas fa-play"></i> {{ 'Retomar' if campaign.status != 'PENDING' else 'Iniciar' }}
                                </button>
                            </form>
                        {% elif campaign.status == 'IN_PROGRESS' %}
                             <button class="btn btn-sm btn-warning" disabled title="Pausar Disparos (Em breve)">
                                <i class="fas fa-pause"></i> Pausar
                             </button>
                        {% endif %}
                        <a href="{{ url_for('campaign_details_page', campaign_id=campaign.campaign_id) }}" class="btn btn-sm btn-info" title="Ver Detalhes e Logs">
                            <i class="fas fa-eye"></i> Detalhes
                        </a>
                    </td>
                </tr>
                {# Linha para logs, inicialmente oculta #}
                <tr class="campaign-log-row" data-log-for="{{ campaign.campaign_id }}" style="display: none;">
                    <td colspan="8">
                        <strong>Log de Disparos ({{ campaign.campaign_id }}):</strong>
                        <div id="log-area-{{ campaign.campaign_id }}" class="campaign-log-area">
                            <small>Aguardando logs...</small>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="alert alert-info">
        Nenhuma campanha criada ainda. <a href="{{ url_for('create_campaign') }}" class="alert-link">Clique aqui para criar sua primeira campanha!</a>
    </div>
{% endif %}
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<style>
    .campaign-log-area {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 8px;
        margin-top: 5px;
        font-size: 0.85em;
        background-color: #f9f9f9;
    }
    .campaign-log-area p {
        margin-bottom: 0.3rem;
        border-bottom: 1px dashed #eee;
        padding-bottom: 0.3rem;
    }
    .campaign-log-area p:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}


{% block scripts %}
{{ super() }} {# Garante que scripts do base.html como jQuery e Bootstrap JS são carregados antes #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();

        socket.on('connect', function() {
            console.log('Frontend: Conectado ao servidor Socket.IO!');
        });

        socket.on('response', function(msg) {
            console.log('Frontend: Resposta do servidor:', msg);
        });

        function updateCampaignStatus(campaignId, statusText, badgeClass) {
            const campaignRow = document.querySelector(`tr[data-campaign-id="${campaignId}"]`);
            if (campaignRow) {
                const statusCell = campaignRow.querySelector('.campaign-status-cell');
                if (statusCell) {
                    statusCell.innerHTML = `<span class="badge badge-pill ${badgeClass}">${statusText.replace('_', ' ')}</span>`;
                }
                // Habilitar/desabilitar botão de iniciar
                const startButton = campaignRow.querySelector('.btn-start-campaign');
                if (startButton) {
                    if (statusText === 'IN_PROGRESS' || statusText === 'COMPLETED') {
                        startButton.style.display = 'none'; // Esconde o botão de iniciar
                    } else {
                         startButton.style.display = 'inline-block'; // Mostra
                         startButton.innerHTML = '<i class="fas fa-play"></i> Retomar';
                    }
                }
            }
        }

        function updateCampaignProgress(campaignId, processed, total, success, failed, status_message) {
            const progressTextDiv = document.getElementById(`progress-text-${campaignId}`);
            const progressBarContainer = document.getElementById(`progress-bar-container-${campaignId}`);
            const progressBar = document.getElementById(`progress-bar-${campaignId}`);

            if (progressTextDiv && progressBar && progressBarContainer) {
                progressBarContainer.style.display = 'flex';
                let percentage = total > 0 ? (processed / total) * 100 : 0;
                progressBar.style.width = percentage + '%';
                progressBar.setAttribute('aria-valuenow', percentage);
                
                let text = `Processados: ${processed}/${total}`;
                if (status_message) {
                    text = status_message;
                } else if (processed === total && total > 0) {
                    text = `Concluído: ${success} sucesso(s), ${failed} falha(s).`;
                } else if (processed > 0) {
                     text = `Processando: ${processed}/${total} (S:${success}, F:${failed})`;
                }
                 progressTextDiv.innerHTML = `<small>${text}</small>`;
            }
        }
        
        function addCampaignLog(campaignId, logData) {
            const logArea = document.getElementById(`log-area-${campaignId}`);
            const logRow = document.querySelector(`tr.campaign-log-row[data-log-for="${campaignId}"]`);
            if (logArea && logRow) {
                logRow.style.display = 'table-row'; // Mostra a linha de log
                if (logArea.innerHTML.includes('Aguardando logs...')) {
                    logArea.innerHTML = ''; // Limpa mensagem inicial
                }
                const logEntry = document.createElement('p');
                let statusColor = 'text-muted';
                if (logData.status === 'SENT_SUCCESS') statusColor = 'text-success';
                else if (logData.status === 'SENT_FAILED') statusColor = 'text-danger';
                else if (logData.status === 'PROCESSING') statusColor = 'text-info';

                logEntry.className = statusColor;
                logEntry.innerHTML = `
                    <small>[${new Date().toLocaleTimeString()}] <strong>${logData.contact_name || logData.contact_phone}</strong>:
                    ${logData.status.replace('_', ' ')}
                    ${logData.message && logData.message.includes('Falha') ? `(${logData.api_response || ''})` : ''}
                    </small>`;
                logArea.appendChild(logEntry);
                logArea.scrollTop = logArea.scrollHeight; // Auto-scroll
            }
        }

        socket.on('campaign_status_update', function(data) {
            console.log('SocketIO Event: campaign_status_update', data);
            let badgeClass = 'badge-info'; // Default para IN_PROGRESS
            updateCampaignStatus(data.campaign_id, data.status, badgeClass);
            if (data.status === 'IN_PROGRESS'){
                 updateCampaignProgress(data.campaign_id, 0, 0, 0, 0, data.message || "Iniciando...");
                 const logRow = document.querySelector(`tr.campaign-log-row[data-log-for="${data.campaign_id}"]`);
                 if (logRow) logRow.style.display = 'table-row';
                 const logArea = document.getElementById(`log-area-${data.campaign_id}`);
                 if(logArea && logArea.innerHTML.includes('Aguardando logs...')) logArea.innerHTML = ''; // Limpa
            }
        });

        socket.on('campaign_progress', function(data) {
            console.log('SocketIO Event: campaign_progress', data);
            updateCampaignProgress(data.campaign_id, data.processed, data.total, data.success, data.failed, data.status_text);
            updateCampaignStatus(data.campaign_id, "IN_PROGRESS", "badge-info");
        });

        socket.on('dispatch_update', function(data) {
            console.log('SocketIO Event: dispatch_update', data);
            addCampaignLog(data.campaign_id, data);
        });
        
        socket.on('campaign_finished', function(data) {
            console.log('SocketIO Event: campaign_finished', data);
            let badgeClass = 'badge-light';
            if (data.status === 'COMPLETED') badgeClass = 'badge-success';
            else if (data.status === 'COMPLETED_WITH_ERRORS') badgeClass = 'badge-warning';
            else if (data.status === 'FAILED') badgeClass = 'badge-danger';
            updateCampaignStatus(data.campaign_id, data.status, badgeClass);
            updateCampaignProgress(data.campaign_id, data.total_dispatches, data.total_dispatches, data.success_count, data.failure_count, null);
            
            // Opcional: Adicionar um log final de conclusão
            addCampaignLog(data.campaign_id, {
                contact_name: "Sistema",
                status: data.status,
                message: `Campanha finalizada. Sucesso: ${data.success_count}, Falhas: ${data.failure_count}.`
            });
        });

        socket.on('campaign_error', function(data) {
            console.error('SocketIO Event: campaign_error', data);
            updateCampaignStatus(data.campaign_id, "ERRO", "badge-danger");
            const progressTextDiv = document.getElementById(`progress-text-${data.campaign_id}`);
            if(progressTextDiv) progressTextDiv.innerHTML = `<small class="text-danger">Erro: ${data.message}</small>`;
            addCampaignLog(data.campaign_id, { contact_name: "Sistema", status: "ERRO", message: data.message, api_response: ""});
        });

        socket.on('campaign_log', function(data) { // Para logs gerais da campanha
            console.info('SocketIO Event: campaign_log', data);
             addCampaignLog(data.campaign_id, { contact_name: "Sistema", status: "INFO", message: data.message, api_response: ""});
        });

    });
</script>
{% endblock %}